{% raw %}{% include './common.j2' %}{% endraw %}
fs:
  # root
  "/":
    readdir: 
      sh: ls /accounts
    getattr:
      sh: *dir 
      # /<id>
    "/[0-9]+":
      name: id
      readdir: 
        list: 
        - vm
      getattr: 
          sh: *dir
      # /<id>/.init.lua
      "/.init.lua":
        getattr:
          sh: *file
        read_file: 
          sh: |
            cat <<EOF
{% filter indent(15, first=True) -%}
                  {% include '.init.lua'%}
                  {%- endfilter %}       
            EOF
            
      # /<id>/vm
      "/vm":
        readdir:
          list: 
          - list
        getattr:
          sh: *dir
          # /<id>/vm/list
        "/list":
          cache: 360
          readdir:
            sh: export AZURE_CONFIG_DIR=/accounts/$id/credentials && az vm list | jq -r '.[].name'
          getattr:
            sh: *dir 
          # /<id>/vm/list/<instance>
          "/[a-z0-9_-]+":
            name: instancename
            getattr: 
              sh: *dir 
            readdir: 
              sh: export AZURE_CONFIG_DIR=/accounts/$id/credentials && az vm list | jq -r ".[] | select (.name==\"$instancename\")" | jq -r "keys[]"
            # /<id>/vm/list/<instance>/<parameter>
            "/[a-zA-Z0-9_-]+":
              name: parameter
              getattr:
                sh: *file
              read_file:
                sh: export AZURE_CONFIG_DIR=/accounts/$id/credentials && az vm list | jq -r ".[] | select (.name==\"$instancename\") .\"$parameter\""
